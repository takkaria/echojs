{% extends "layout.html" %}

{% block title %}{{ event_.title }}{% endblock %}
{% block pageclass %}event{% endblock %}
{% block meta %}

  <meta property="og:site_name" content="Echo Manchester">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@EchoManchester">

  <meta property="og:title" content="{{ event_.title }}">
  <meta name="twitter:title" content="{{ event_.title }}">

  <meta name="twitter:description" content="{{ event_.shortBlurb(false) }}">
  <meta property="og:description" content="{{ event_.shortBlurb(false) }}">

{% endblock %}

{% block header %}{% spaceless %}

<ol class="breadcrumb">
  <li><a href="/">Echo</a></li>
  <li><a href="/events">Events</a></li>
  <li><a href="/events/{{ event_.startdt.format("YYYY/MMM") | lower }}">{{ event_.startdt.format("MMMM YYYY") }}</a></li>
</ol>

  <h2 class="header-title">
    {{ event_.title }}

    {% if user.rights === 'admin' or user.rights === 'editor' %}
    <a href="/admin/event/{{ event_.id }}/edit" class="btn btn-xs btn-primary">edit</a>
    <span class="btn btn-xs btn-info">status '{{ event_.state }}'</span>
    {% endif %}

    {% if user.rights === 'admin' or user.rights === 'editor' %}
      {% if event_.state == "submitted" %}
        <a href="/admin/event/{{ event_.id }}/approve" class="btn btn-xs btn-success">
          approve
        </a>
        <a href="/admin/event/{{ event_.id }}/reject" class="btn btn-xs btn-warning">
          reject
        </a>
      {% elif event_.state== "approved" %}
        <a href="/admin/event/{{ event_.id }}/reject" class="btn btn-xs btn-warning">
          un-approve
        </a>
      {% endif %}

      {% if event_.state == "hidden" %}
        <a href="/admin/event/{{ event_.id }}/approve" class="btn btn-xs btn-success">
          approve
        </a>
      {% endif %}

    {% endif %}
  </h2>

  <h4 class="header-date">
    {% if event_.allday %}
      {{ event_.startdt.format("dddd, Do MMMM") }}
    {% else %}
      {{ event_.startdt.format("dddd, Do MMMM, h:mma") }}
    {% endif %}

    {% if event_.enddt %}
      &nbsp;&ndash;&nbsp;

      {% if event_.isMultiDay() %}
        {% if event_.allday %}
          {{ event_.enddt.format("dddd, Do MMMM") }}
        {% else %}
          {{ event_.enddt.format("dddd, Do MMMM, ") }}
        {% endif %}
      {% endif %}

      {% if !event_.allday %}
        {{ event_.enddt.format("h:mma") }}
      {% endif %}

    {% endif %}
  </h4>

{% endspaceless %}{% endblock %}

{% block leftcontent %}

{% if event_.host %}
<p><i>Hosted by <b>{{ event_.host }}</b></i></p>
{% endif %}

{{ event_.blurbAsHTML() }}

<h3 class="header-box">More information</h3>

{% if event_.url %}
<p>
  {% if event_.url.hostNoWww == "facebook.com" %}
    <i class="fa fa-fw fa-facebook"></i> <a href="{{ event_.url.href }}" target="_blank">Facebook event</a>
  {% else %}
    <i class="fa fa-fw fa-external-link"></i> <a href="{{ event_.url.href }}" target="_blank">{{ event_.url.hostNoWww }}</a>
  {% endif %}
</p>
{% endif %}

<h3 class="header-box">Location</h3>
{% if event_.location %}
  <p><i class="fa fa-fw fa-map-marker"></i> <a href="/location/{{ event_.location.id }}">{{ event_.shortLocation }}</a></p>
  <div id="map-canvas"></div>
{% else %}
  <p><i class="fa fa-fw fa-map-marker"></i> {{ event_.shortLocation }}</p>
{% endif %}

{% endblock %}


{% macro listEvents(header, list) %}
{% if list.length > 0 %}
  <h4 class="sidebar-header">{{ header }}</h4>
  <ul class="sidebar-list">
    {% for event_ in list %}
      <a href="{{ event_.absoluteURL }}">
        <li>
          <span class="title">{{ event_.title }}</span>
          ({{ event_.startdt.format("DD MMM") }})
        </li>
      </a>
    {% endfor %}
  </ul>
{% endif %}
{% endmacro %}

{% block rightcontent %}
<div class="sidebar">
  {{ listEvents("Upcoming events with this host", otherEventsHost) }}
  {{ listEvents("Upcoming events at this location", otherEventsLocation) }}
</div>
{% endblock %}


{% block script %}

{% if event_.location %}

<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyCIIJrpahlkTrn1e4wkIujyzqCEfK_C9_M"></script>
<script>
  function initialize() {
    var myLatlng = new google.maps.LatLng({{ event_.location.latitude }}, {{ event_.location.longitude }});
    var mapOptions = {
      zoom: 15,
      center: myLatlng
    }
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    var infowindow = new google.maps.InfoWindow({
        content: "<div style='width: 200px;'><b>{{ event_.location.name }}</b><br>{{ event_.location.addressAsHTML() }}</div>",
        maxWidth: 500
    });

    var marker = new google.maps.Marker({
        position: myLatlng,
        map: map,
        title: 'Hello World!'
    });

    infowindow.open(map, marker);
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>

{% endif %}

{% endblock %}
